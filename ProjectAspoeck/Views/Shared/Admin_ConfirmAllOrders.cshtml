@model ProjectAspoeck.Models.AdminConfirmAllOrdersModel
@{
    ViewData["Title"] = "Confirm All Orders";
}
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Alle letzten Bestellungen</title>
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/>
    <script src="https://kit.fontawesome.com/afdaaa5e13.js" crossorigin="anonymous"></script>
    <style>
        .header-image {
            padding-left: 50px;
            height: 100%;
        }

        img {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        .header-text {
            padding-right: 50px;
            text-align: center;
        }

        .header-right-text,
        .btn {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .table th,
        .table td {
            font-size: 1.2rem;
        }

        .my-custom-scrollbar {
            position: relative;
            height: 100%;
            overflow: auto;
        }

        .table-wrapper-scroll-y {
            display: block;
            overflow: auto;
            max-height: calc(100vh - 340px);
        }

        .headline {
            padding-top: 10px;
        }

        body {
            overflow: hidden;
        }
        
        .sticky-top {
          position: sticky;
          top: 0;
          z-index: 1;
          background-color: #fff;
        }
        
        .text-center-last-col {
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>
<header class="bg-light py-3" style="height: 150px">
    <div class="container-fluid h-100">
        <div class="row align-items-center h-100">
            <div class="col-3 header-image">
                <img src="~/Images/aspoeck-logo-sm.png"
                     class="img-fluid align-middle"
                     alt="Logo"/>
            </div>
            <div class="col-6 header-text">
                <h1 class="mb-0">Jausen Bestellung</h1>
            </div>
            <div class="col-3 text-center bg-warning py-2">
                <p class="mb-0 align-middle header-right-text">ADMINISTRATOR</p>
            </div>
        </div>
    </div>
</header>

<div class="container-fluid">
    <div class="row">
        <div class="col headline">
            <h4>Alle letzten Bestellungen</h4>
        </div>
    </div>
    <div class="row mt-3 flex-fill">
        <div class="col">
            <div class="form-group d-flex align-items-center">
                <label for="allUsers" class="mr-3">Benutzer:</label>
                <select class="form-control" id="allUsers" style="width: 160px">
                    <option value="all">Alle</option>
                    @foreach(var user in Model.Users)
                    {
                        <option value="@user.UserName">@user.UserName</option>
                    }
                </select>
            </div>
            <div class="table-wrapper-scroll-y my-custom-scrollbar table-responsive">
                <table class="table table-bordered table-striped" id="table">
                    <thead class="sticky-top">
                    <tr>
                        <th>Nr</th>
                        <th>Datum</th>
                        <th>Benutzer</th>
                        <th>Inhalt</th>
                        <th>Status</th>
                        <th>Kosten</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var order in Model.Orders)
                    {
                        <tr>
                            <td>
                                @if (order.OrderNumber != -1)
                                {
                                    @order.OrderNumber
                                }
                            </td>
                            <td>
                                @order.OrderDate
                            </td>
                            <td>
                                @order.UserName
                            </td>
                            <td>
                                @order.OrderContent
                            </td>
                            <td>
                                @if(order.OrderAmount != -1)
                                {
                                    <select class="form-select" id="orderState-@order.OrderId" onchange="stateChanged('@order.OrderId')">
                                        @foreach (var state in Model.OrderStates)
                                        {
                                            @if (state.Name == order.OrderState)
                                            {
                                                <option selected="selected">@state.Name</option>
                                            }
                                            else
                                            {
                                                <option>@state.Name</option>
                                            }
                                        }
                                    </select>
                                }
                            </td>
                            <td>
                                @if (order.OrderPrice != -1)
                                {
                                    @order.OrderPrice.ToString("N2")
                                    @Html.Raw(" €")
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-6 text-left">
            @using (Html.BeginForm("Admin_Home_Page", "Admin", FormMethod.Post))
            {
                <button href="#" class="btn btn-warning">Zurück</button>
            }
        </div>
        <div class="col-6 text-right">
            <button id="completePayment" class="btn btn-warning">Bezahlung abschließen</button>
        </div>
    </div>
</div>
</body>
</html>

@section Scripts
{
    <script>    
    $(document).ready(function () {
        $("#allUsers").change(function () {
            const selectedValue = $(this).val();
            console.log('selectedValue: ' + selectedValue);
            if (selectedValue === "all") {
                $("#table tbody tr").show();
            } else {
                $("#table tbody tr").hide();
                $('#table').removeClass('table-striped');
                $("#table tbody tr td:nth-child(3)").filter(function () {
                    const selectValue = $(this).text().trim();
                    console.log('selectValue: ' + selectValue);
                    return selectValue === selectedValue;
                }).parent().show();
                $('#table').addClass('table-striped');
            }
        });
            
        $('#completePayment').on('click', function() {
            const table = document.getElementById('table');
            const selects = table.getElementsByTagName('select');
            
            for (let i = 0; i < selects.length; i++) {
                if (!selects[i].parentNode.parentNode.style.display.includes('none')) {
                  for (let j = 0; j < selects[i].options.length; j++) {
                    if (selects[i].options[j].value === 'bezahlt') {
                      selects[i].options[j].selected = true;
                      break;
                    }
                  }
                  selects[i].dispatchEvent(new Event('change'));
                }
            }
            location.reload();
        });
    });  
    
    function stateChanged(id) {
        console.log('********************** stateChanged **********************');
        console.log('id: ' + id);
        const orderStateName = document.getElementById('orderState-' + id).value;
        console.log('orderStateName: ' + orderStateName);
        $.ajax({
            url: '@Url.Action("UpdateOrderState", "AdminAllOrders")',
            type: 'POST',
            data: { 
                orderId: id,
                stateName: orderStateName 
            },
            success: function (result) {
                if (result.success) {
                    location.reload();
                }
                else 
                {
                    alert(result.message);
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                alert('Ein Fehler ist aufgetreten: ' + errorThrown);
            }
        });
    
        $('#orderState').val();
    }
    </script>
}
